#!/bin/bash
CWD="$(pwd)"
PY2="$(which python2)"
PY3="$(which python3)"
WRITE_MEM=""

if [[ ! -z "${PY3}" ]];
then
    WRITE_MEM="IyEvdXNyL2Jpbi9weXRob24KCiMgaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTI5NzcxNzkvcmVhZGluZy1saXZpbmctcHJvY2Vzcy1tZW1vcnktd2l0aG91dC1pbnRlcnJ1cHRpbmctaXQKCgppbXBvcnQgcmUKaW1wb3J0IHN5cwppbXBvcnQgb3MKZGVmIHByaW50X21lbW9yeV9vZl9waWQocGlkLCBvbmx5X3dyaXRhYmxlPVRydWUpOgogICAgIiIiIAogICAgUnVuIGFzIHJvb3QsIHRha2UgYW4gaW50ZWdlciBQSUQgYW5kIHJldHVybiB0aGUgY29udGVudHMgb2YgbWVtb3J5IHRvIFNURE9VVAogICAgIiIiCiAgICBjdXJyZW50X2RpcmVjdG9yeSA9IG9zLmdldGN3ZCgpCiAgICBtZW1vcnlfcGVybWlzc2lvbnMgPSAncncnIGlmIG9ubHlfd3JpdGFibGUgZWxzZSAnci0nCiAgICBwcm9jX21hcHMgPSAiL3Byb2MvIiArIHN0cihwaWQpICsgIi9tYXBzIgogICAgcHJvY19tZW0gID0gIi9wcm9jLyIgKyBzdHIocGlkKSArICIvbWVtIgogICAgd2l0aCBvcGVuKHByb2NfbWFwcywgJ3InKSBhcyBtYXBzX2ZpbGU6CiAgICAgICAgd2l0aCBvcGVuKHByb2NfbWVtLCAncmInKSBhcyBtZW1fZmlsZToKICAgICAgICAgICAgZm9yIGxpbmUgaW4gbWFwc19maWxlLnJlYWRsaW5lcygpOiAgIyBmb3IgZWFjaCBtYXBwZWQgcmVnaW9uCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgbSA9IHJlLm1hdGNoKHInKFswLTlBLUZhLWZdKyktKFswLTlBLUZhLWZdKykgKFstcl1bLXddKScsIGxpbmUpCiAgICAgICAgICAgICAgICAgICAgaWYgbS5ncm91cCgzKSA9PSBtZW1vcnlfcGVybWlzc2lvbnM6IAogICAgICAgICAgICAgICAgICAgICAgICBzeXMuc3RkZXJyLndyaXRlKCJcbk9LIDogXG4iICsgbGluZSsiXG4iKQogICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IGludChtLmdyb3VwKDEpLCAxNikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc3RhcnQgPiAweEZGRkZGRkZGRkZGRjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVuZCA9IGludChtLmdyb3VwKDIpLCAxNikKICAgICAgICAgICAgICAgICAgICAgICAgbWVtX2ZpbGUuc2VlayhzdGFydCkgICMgc2VlayB0byByZWdpb24gc3RhcnQKICAgICAgICAgICAgICAgICAgICAgICAgY2h1bmsgPSBtZW1fZmlsZS5yZWFkKGVuZCAtIHN0YXJ0KSMgcmVhZCByZWdpb24gY29udGVudHMKICAgICAgICAgICAgICAgICAgICAgICAgcGF0aF9kaXIgPSBjdXJyZW50X2RpcmVjdG9yeSArICIvIiArIHN0cihwaWQpICsgIl9kbXAubG9nIgogICAgICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4ocGF0aF9kaXIsICd3YicpIGFzIG91dDojIGR1bXAgY29udGVudHMgdG8gc3RhbmRhcmQgb3V0cHV0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXQud3JpdGUoY2h1bmspCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc3lzLnN0ZGVyci53cml0ZSgiXG5QQVNTIDogXG4iICsgbGluZSsiXG4iKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIHByaW50KCJNZXNzYWdlOiAiICsgZSkKCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6ICMgRXhlY3V0ZSB0aGlzIGNvZGUgd2hlbiBydW4gZnJvbSB0aGUgY29tbWFuZGxpbmUuCiAgICBhcmd1bWVudHMgPSAnICcuam9pbihzeXMuYXJndikKICAgIHRyeToKICAgICAgICBhc3NlcnQgbGVuKHN5cy5hcmd2KSA9PSAyLCAiUHJvdmlkZSBleGFjdGx5IDEgUElEIChwcm9jZXNzIElEKSIKICAgICAgICBwaWQgPSBpbnQoc3lzLmFyZ3ZbMV0pCiAgICAgICAgcHJpbnRfbWVtb3J5X29mX3BpZChwaWQpCiAgICBleGNlcHQgKEFzc2VydGlvbkVycm9yLCBWYWx1ZUVycm9yKSBhcyBlOgogICAgICAgIHByaW50KCJQbGVhc2UgcHJvdmlkZSAxIFBJRCBhcyBhIGNvbW1hbmRsaW5lIGFyZ3VtZW50LiIpCiAgICAgICAgcHJpbnQoIllvdSBlbnRlcmVkOiAiICsgYXJndW1lbnRzKQogICAgICAgIHJhaXNlIGUK"
else
    WRITE_MEM="IyEvdXNyL2Jpbi9lbnYgcHl0aG9uCgppbXBvcnQgcmUKaW1wb3J0IHN5cwoKZGVmIHByaW50X21lbW9yeV9vZl9waWQocGlkLCBvbmx5X3dyaXRhYmxlPVRydWUpOgogICAgIiIiIAogICAgUnVuIGFzIHJvb3QsIHRha2UgYW4gaW50ZWdlciBQSUQgYW5kIHJldHVybiB0aGUgY29udGVudHMgb2YgbWVtb3J5IHRvIFNURE9VVAogICAgIiIiCiAgICBtZW1vcnlfcGVybWlzc2lvbnMgPSAncncnIGlmIG9ubHlfd3JpdGFibGUgZWxzZSAnci0nCiAgICBzeXMuc3RkZXJyLndyaXRlKCJQSUQgPSAlZCIgJSBwaWQpCiAgICB3aXRoIG9wZW4oIi9wcm9jLyVkL21hcHMiICUgcGlkLCAncicpIGFzIG1hcHNfZmlsZToKICAgICAgICB3aXRoIG9wZW4oIi9wcm9jLyVkL21lbSIgJSBwaWQsICdyJywgMCkgYXMgbWVtX2ZpbGU6CiAgICAgICAgICAgIGZvciBsaW5lIGluIG1hcHNfZmlsZS5yZWFkbGluZXMoKTogICMgZm9yIGVhY2ggbWFwcGVkIHJlZ2lvbgogICAgICAgICAgICAgICAgbSA9IHJlLm1hdGNoKHInKFswLTlBLUZhLWZdKyktKFswLTlBLUZhLWZdKykgKFstcl1bLXddKScsIGxpbmUpCiAgICAgICAgICAgICAgICBpZiBtLmdyb3VwKDMpID09IG1lbW9yeV9wZXJtaXNzaW9uczogCiAgICAgICAgICAgICAgICAgICAgc3lzLnN0ZGVyci53cml0ZSgiXG5PSyA6IFxuIiArIGxpbmUrIlxuIikKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IGludChtLmdyb3VwKDEpLCAxNikKICAgICAgICAgICAgICAgICAgICBpZiBzdGFydCA+IDB4RkZGRkZGRkZGRkZGOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIGVuZCA9IGludChtLmdyb3VwKDIpLCAxNikKICAgICAgICAgICAgICAgICAgICBzeXMuc3RkZXJyLndyaXRlKCAic3RhcnQgPSAiICsgc3RyKHN0YXJ0KSArICJcbiIpCiAgICAgICAgICAgICAgICAgICAgbWVtX2ZpbGUuc2VlayhzdGFydCkgICMgc2VlayB0byByZWdpb24gc3RhcnQKICAgICAgICAgICAgICAgICAgICBjaHVuayA9IG1lbV9maWxlLnJlYWQoZW5kIC0gc3RhcnQpICAjIHJlYWQgcmVnaW9uIGNvbnRlbnRzCiAgICAgICAgICAgICAgICAgICAgcHJpbnQgY2h1bmssICAjIGR1bXAgY29udGVudHMgdG8gc3RhbmRhcmQgb3V0cHV0CiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHN5cy5zdGRlcnIud3JpdGUoIlxuUEFTUyA6IFxuIiArIGxpbmUrIlxuIikKCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6ICMgRXhlY3V0ZSB0aGlzIGNvZGUgd2hlbiBydW4gZnJvbSB0aGUgY29tbWFuZGxpbmUuCiAgICB0cnk6CiAgICAgICAgYXNzZXJ0IGxlbihzeXMuYXJndikgPT0gMiwgIlByb3ZpZGUgZXhhY3RseSAxIFBJRCAocHJvY2VzcyBJRCkiCiAgICAgICAgcGlkID0gaW50KHN5cy5hcmd2WzFdKQogICAgICAgIHByaW50X21lbW9yeV9vZl9waWQocGlkKQogICAgZXhjZXB0IChBc3NlcnRpb25FcnJvciwgVmFsdWVFcnJvcikgYXMgZToKICAgICAgICBwcmludCAiUGxlYXNlIHByb3ZpZGUgMSBQSUQgYXMgYSBjb21tYW5kbGluZSBhcmd1bWVudC4iCiAgICAgICAgcHJpbnQgIllvdSBlbnRlcmVkOiAlcyIgJSAnICcuam9pbihzeXMuYXJndikKICAgICAgICByYWlzZSBlCg=="
fi

function create_dump ( ) {
    echo "${WRITE_MEM}" | base64 -d > ./write_mem.py
    if [[ ! -z "${PY3}" ]];
    then
        python3 ./write_mem.py ${1}
    else
        python2 ./write_mem.py ${1}
    fi
    ls -la
}

create_dump $1

echo "[ + ] Created memory dump of PID: ${1}, output: ${1}_mem_dmp.log"
