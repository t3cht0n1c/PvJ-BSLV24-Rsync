#!/bin/bash

# Modified script of aide_setup.sh by PvJ Blue Team setup for AIDE
CWD=$(pwd)
TIMESTAMP="$(date +%Y%m%d%H%M%S)"
RED='\e[0;31m'
GREEN='\e[0;32m'
YELLOW='\e[1;33m'
NC='\e[0m'

function echo_info ( ) {
    echo -n -e "${GREEN} ${1} ${NC}"
}

function echo_warn ( ) {
    echo -n -e "${YELLOW} ${1} ${NC}"
}

function echo_fail ( ) {
    echo -n -e "${RED} ${1} ${NC}"
}

AIDE="$(which aide)"
UNAME="$(uname -a | awk -F' ' '{print $1_$3_$4}')"
OS="$(cat /etc/os-release | grep '^NAME=\".*\"$' | cut -d '"' -f 2 | tr $'\n' ' ' | cut -d ' ' -f 1)"
if [[ -z "${AIDE}" ]];
then
    echo_fail "[ ! ] AIDE is not installed!\n"
    case "${OS}" in
        Ubuntu)
            apt-get install aide -y
            ;;
        Debian)
            apt-get install aide -y
            ;;
        CentOS)
            yum install -y aide
            ;;
        *)
            echo_fail "[ ! ] OS not supported"
            ;;
    esac
fi
AIDE="$(which aide)"
echo_info "[ + ] AIDE setup starting\n"
AIDE_CONF_FILE="/etc/aide_pvf.conf"
AIDE_CONF="IyBFeGFtcGxlIGNvbmZpZ3VyYXRpb24gZmlsZSBmb3IgQUlERS4KCkBAZGVmaW5lIERCRElSIC92YXIvbGliL2FpZGUKQEBkZWZpbmUgTE9HRElSIC92YXIvbG9nL2FpZGUKCiMgVGhlIGxvY2F0aW9uIG9mIHRoZSBkYXRhYmFzZSB0byBiZSByZWFkLgpkYXRhYmFzZV9pbj1maWxlOkBAe0RCRElSfS9haWRlLmRiLmd6CgojIFRoZSBsb2NhdGlvbiBvZiB0aGUgZGF0YWJhc2UgdG8gYmUgd3JpdHRlbi4KI2RhdGFiYXNlX291dD1zcWw6aG9zdDpwb3J0OmRhdGFiYXNlOmxvZ2luX25hbWU6cGFzc3dkOnRhYmxlCiNkYXRhYmFzZV9vdXQ9ZmlsZTphaWRlLmRiLm5ldwpkYXRhYmFzZV9vdXQ9ZmlsZTpAQHtEQkRJUn0vYWlkZS5kYi5uZXcuZ3oKCiMgV2hldGhlciB0byBnemlwIHRoZSBvdXRwdXQgdG8gZGF0YWJhc2UKZ3ppcF9kYm91dD15ZXMKCiMgRGVmYXVsdC4KbG9nX2xldmVsPWluZm8KcmVwb3J0X2xldmVsPWxpc3RfZW50cmllcwoKcmVwb3J0X3VybD1maWxlOkBAe0xPR0RJUn0vYWlkZS5sb2cKcmVwb3J0X3VybD1zdGRvdXQKI3JlcG9ydF91cmw9c3RkZXJyCiNOT1QgSU1QTEVNRU5URUQgcmVwb3J0X3VybD1tYWlsdG86cm9vdEBmb28uY29tCiNOT1QgSU1QTEVNRU5URUQgcmVwb3J0X3VybD1zeXNsb2c6TE9HX0FVVEgKCiMgVGhlc2UgYXJlIHRoZSBkZWZhdWx0IHJ1bGVzLgojCiNwOiAgICAgIHBlcm1pc3Npb25zCiNpOiAgICAgIGlub2RlOgojbjogICAgICBudW1iZXIgb2YgbGlua3MKI3U6ICAgICAgdXNlcgojZzogICAgICBncm91cAojczogICAgICBzaXplCiNiOiAgICAgIGJsb2NrIGNvdW50CiNtOiAgICAgIG10aW1lCiNhOiAgICAgIGF0aW1lCiNjOiAgICAgIGN0aW1lCiNTOiAgICAgIGNoZWNrIGZvciBncm93aW5nIHNpemUKI2FjbDogICAgICAgICAgIEFjY2VzcyBDb250cm9sIExpc3RzCiNzZWxpbnV4ICAgICAgICBTRUxpbnV4IHNlY3VyaXR5IGNvbnRleHQKI3hhdHRyczogICAgICAgIEV4dGVuZGVkIGZpbGUgYXR0cmlidXRlcwojbWQ1OiAgICBtZDUgY2hlY2tzdW0KI3NoYTE6ICAgc2hhMSBjaGVja3N1bQojc2hhMjU2OiAgICAgICAgc2hhMjU2IGNoZWNrc3VtCiNzaGE1MTI6ICAgICAgICBzaGE1MTIgY2hlY2tzdW0KI3JtZDE2MDogcm1kMTYwIGNoZWNrc3VtCiN0aWdlcjogIHRpZ2VyIGNoZWNrc3VtCgojaGF2YWw6ICBoYXZhbCBjaGVja3N1bSAoTUhBU0ggb25seSkKI2dvc3Q6ICAgZ29zdCBjaGVja3N1bSAoTUhBU0ggb25seSkKI2NyYzMyOiAgY3JjMzIgY2hlY2tzdW0gKE1IQVNIIG9ubHkpCiN3aGlybHBvb2w6ICAgICB3aGlybHBvb2wgY2hlY2tzdW0gKE1IQVNIIG9ubHkpCgojUjogICAgICAgICAgICAgcCtpK24rdStnK3MrbStjK2FjbCtzZWxpbnV4K3hhdHRycyttZDUKI0w6ICAgICAgICAgICAgIHAraStuK3UrZythY2wrc2VsaW51eCt4YXR0cnMKI0U6ICAgICAgICAgICAgIEVtcHR5IGdyb3VwCiM+OiAgICAgICAgICAgICBHcm93aW5nIGxvZ2ZpbGUgcCt1K2craStuK1MrYWNsK3NlbGludXgreGF0dHJzCgojIFlvdSBjYW4gY3JlYXRlIGN1c3RvbSBydWxlcyBsaWtlIHRoaXMuCiMgV2l0aCBNSEFTSC4uLgojIEFMTFhUUkFIQVNIRVMgPSBzaGExK3JtZDE2MCtzaGEyNTYrc2hhNTEyK3doaXJscG9vbCt0aWdlcitoYXZhbCtnb3N0K2NyYzMyCkFMTFhUUkFIQVNIRVMgPSBzaGExK3JtZDE2MCtzaGEyNTYrc2hhNTEyK3RpZ2VyCiMgRXZlcnl0aGluZyBidXQgYWNjZXNzIHRpbWUgKEllLiBhbGwgY2hhbmdlcykKRVZFUllUSElORyA9IFIrQUxMWFRSQUhBU0hFUwoKIyBTYW5lLCB3aXRoIG11bHRpcGxlIGhhc2hlcwojIE5PUk1BTCA9IFIrcm1kMTYwK3NoYTI1Nit3aGlybHBvb2wKTk9STUFMID0gUitybWQxNjArc2hhMjU2CgojIEZvciBkaXJlY3RvcmllcywgZG9uJ3QgYm90aGVyIGRvaW5nIGhhc2hlcwpESVIgPSBwK2krbit1K2crYWNsK3NlbGludXgreGF0dHJzCgojIEFjY2VzcyBjb250cm9sIG9ubHkKUEVSTVMgPSBwK2krdStnK2FjbCtzZWxpbnV4CgojIExvZ2ZpbGUgYXJlIHNwZWNpYWwsIGluIHRoYXQgdGhleSBvZnRlbiBjaGFuZ2UKTE9HID0gPgoKIyBKdXN0IGRvIG1kNSBhbmQgc2hhMjU2IGhhc2hlcwpMU1BQID0gUitzaGEyNTYKCiMgU29tZSBmaWxlcyBnZXQgdXBkYXRlZCBhdXRvbWF0aWNhbGx5LCBzbyB0aGUgaW5vZGUvY3RpbWUvbXRpbWUgY2hhbmdlCiMgYnV0IHdlIHdhbnQgdG8ga25vdyB3aGVuIHRoZSBkYXRhIGluc2lkZSB0aGVtIGNoYW5nZXMKREFUQU9OTFkgPSAgcCtuK3UrZytzK2FjbCtzZWxpbnV4K3hhdHRycyttZDUrc2hhMjU2K3JtZDE2MCt0aWdlcgoKIyBOZXh0IGRlY2lkZSB3aGF0IGRpcmVjdG9yaWVzL2ZpbGVzIHlvdSB3YW50IGluIHRoZSBkYXRhYmFzZS4KCi9ib290ICAgTk9STUFMCi9iaW4gICAgTk9STUFMCi9zYmluICAgTk9STUFMCi9saWIgICAgTk9STUFMCi9saWI2NCAgTk9STUFMCi9vcHQgICAgTk9STUFMCi91c3IgICAgTk9STUFMCi9yb290ICAgTk9STUFMCiMgVGhlc2UgYXJlIHRvbyB2b2xhdGlsZQohL3Vzci9zcmMKIS91c3IvdG1wCgojIENoZWNrIG9ubHkgcGVybWlzc2lvbnMsIGlub2RlLCB1c2VyIGFuZCBncm91cCBmb3IgL2V0YywgYnV0CiMgY292ZXIgc29tZSBpbXBvcnRhbnQgZmlsZXMgY2xvc2VseS4KL2V0YyAgICBQRVJNUwohL2V0Yy9tdGFiCiMgSWdub3JlIGJhY2t1cCBmaWxlcwohL2V0Yy8uKn4KL2V0Yy9leHBvcnRzICBOT1JNQUwKL2V0Yy9mc3RhYiAgICBOT1JNQUwKL2V0Yy9wYXNzd2QgICBOT1JNQUwKL2V0Yy9ncm91cCAgICBOT1JNQUwKL2V0Yy9nc2hhZG93ICBOT1JNQUwKL2V0Yy9zaGFkb3cgICBOT1JNQUwKL2V0Yy9zZWN1cml0eS9vcGFzc3dkICAgTk9STUFMCgovZXRjL2hvc3RzLmFsbG93ICAgTk9STUFMCi9ldGMvaG9zdHMuZGVueSAgICBOT1JNQUwKCi9ldGMvc3Vkb2VycyBOT1JNQUwKL2V0Yy9za2VsIE5PUk1BTAoKL2V0Yy9sb2dyb3RhdGUuZCBOT1JNQUwKCi9ldGMvcmVzb2x2LmNvbmYgREFUQU9OTFkKCi9ldGMvbnNjZC5jb25mIE5PUk1BTAovZXRjL3NlY3VyZXR0eSBOT1JNQUwKCiMgU2hlbGwvWCBzdGFydGluZyBmaWxlcwovZXRjL3Byb2ZpbGUgTk9STUFMCi9ldGMvYmFzaHJjIE5PUk1BTAovZXRjL2Jhc2hfY29tcGxldGlvbi5kLyBOT1JNQUwKL2V0Yy9sb2dpbi5kZWZzIE5PUk1BTAovZXRjL3pwcm9maWxlIE5PUk1BTAovZXRjL3pzaHJjIE5PUk1BTAovZXRjL3psb2dpbiBOT1JNQUwKL2V0Yy96bG9nb3V0IE5PUk1BTAovZXRjL3Byb2ZpbGUuZC8gTk9STUFMCi9ldGMvWDExLyBOT1JNQUwKCiMgUGtnIG1hbmFnZXIKL2V0Yy95dW0uY29uZiBOT1JNQUwKL2V0Yy95dW1leC5jb25mIE5PUk1BTAovZXRjL3l1bWV4LnByb2ZpbGVzLmNvbmYgTk9STUFMCi9ldGMveXVtLyBOT1JNQUwKL2V0Yy95dW0ucmVwb3MuZC8gTk9STUFMCgovdmFyL2xvZyAgIExPRwovdmFyL3J1bi91dG1wIExPRwoKIyBUaGlzIGdldHMgbmV3L3JlbW92ZXMtb2xkIGZpbGVuYW1lcyBkYWlseQohL3Zhci9sb2cvc2EKIyBBcyB3ZSBhcmUgY2hlY2tpbmcgaXQsIHdlJ3ZlIHRydW5jYXRlZCB5ZXN0ZXJkYXlzIHNpemUgdG8gemVyby4KIS92YXIvbG9nL2FpZGUubG9nCgojIExTUFAgcnVsZXMuLi4KIyBBSURFIHByb2R1Y2VzIGFuIGF1ZGl0IHJlY29yZCwgc28gdGhpIGJlY29tZXMgcGVycGV0dWFsIG1vdGlvbi4KIyAvdmFyL2xvZy9hdWRpdC8gTFNQUAovZXRjL2F1ZGl0LyBMU1BQCi9ldGMvbGliYXVkaXQuY29uZiBMU1BQCi91c3Ivc2Jpbi9zdHVubmVsIExTUFAKL3Zhci9zcG9vbC9hdCBMU1BQCi9ldGMvYXQuYWxsb3cgTFNQUAovZXRjL2F0LmRlbnkgTFNQUAovZXRjL2Nyb24uYWxsb3cgTFNQUAovZXRjL2Nyb24uZGVueSBMU1BQCi9ldGMvY3Jvbi5kLyBMU1BQCi9ldGMvY3Jvbi5kYWlseS8gTFNQUAovZXRjL2Nyb24uaG91cmx5LyBMU1BQCi9ldGMvY3Jvbi5tb250aGx5LyBMU1BQCi9ldGMvY3Jvbi53ZWVrbHkvIExTUFAKL2V0Yy9jcm9udGFiIExTUFAKL3Zhci9zcG9vbC9jcm9uL3Jvb3QgTFNQUAoKL2V0Yy9sb2dpbi5kZWZzIExTUFAKL2V0Yy9zZWN1cmV0dHkgTFNQUAovdmFyL2xvZy9mYWlsbG9nIExTUFAKL3Zhci9sb2cvbGFzdGxvZyBMU1BQCgovZXRjL2hvc3RzIExTUFAKL2V0Yy9zeXNjb25maWcgTFNQUAoKL2V0Yy9pbml0YWIgTFNQUAovZXRjL2dydWIvIExTUFAKL2V0Yy9yYy5kIExTUFAKCi9ldGMvbGQuc28uY29uZiBMU1BQCgovZXRjL2xvY2FsdGltZSBMU1BQCgovZXRjL3N5c2N0bC5jb25mIExTUFAKCi9ldGMvbW9kcHJvYmUuY29uZiBMU1BQCgovZXRjL3BhbS5kIExTUFAKL2V0Yy9zZWN1cml0eSBMU1BQCi9ldGMvYWxpYXNlcyBMU1BQCi9ldGMvcG9zdGZpeCBMU1BQCgovZXRjL3NzaC9zc2hkX2NvbmZpZyBMU1BQCi9ldGMvc3NoL3NzaF9jb25maWcgTFNQUAoKL2V0Yy9zdHVubmVsIExTUFAKCi9ldGMvdnNmdHBkLmZ0cHVzZXJzIExTUFAKL2V0Yy92c2Z0cGQgTFNQUAoKL2V0Yy9pc3N1ZSBMU1BQCi9ldGMvaXNzdWUubmV0IExTUFAKCi9ldGMvY3VwcyBMU1BQCgojIFdpdGggQUlERSdzIGRlZmF1bHQgdmVyYm9zaXR5IGxldmVsIG9mIDUsIHRoZXNlIHdvdWxkIGdpdmUgbG90cyBvZgojIHdhcm5pbmdzIHVwb24gdHJlZSB0cmF2ZXJzYWwuIEl0IG1pZ2h0IGNoYW5nZSB3aXRoIGZ1dHVyZSB2ZXJzaW9uLgojCiM9L2xvc3RcK2ZvdW5kICAgIERJUgojPS9ob21lICAgICAgICAgICBESVIKCiMgRGl0dG8gL3Zhci9sb2cvc2EgcmVhc29uLi4uCiEvdmFyL2xvZy9hbmQtaHR0cGQKCiMgQWRtaW5zIGRvdCBmaWxlcyBjb25zdGFudGx5IGNoYW5nZSwganVzdCBjaGVjayBwZXJtcwovcm9vdC9cLi4qIFBFUk1TCg=="
LOCAL_AIDE_DB="aide_db_${TIMESTAMP}_${UNAME}"

echo ${AIDE_CONF} | base64 -d > ${AIDE_CONF_FILE}
${AIDE} -c ${AIDE_CONF_FILE} --init
if [[ "$?" != 0 ]];
then
    echo_fail "[ ! ] ERROR: Something went wrong"
fi

cp /var/lib/aide/aide.db.new.gz "${CWD}/${LOCAL_AIDE_DB}.log"
